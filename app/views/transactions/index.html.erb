<div class="float-right">
  <%= link_to 'Accounts', accounts_path, class: 'btn btn-link' %>
  <button id="link-button" class="btn btn-success">Link Account</button>
</div>

<%= form_tag import_transactions_path, method: :post, class: 'form-inline my-sm-3' do %>
  <div class="form-group">
    <label for="start-date">Start date:</label>
    <input type="date" name="start_date" id="start-date" class="form-control mx-sm-3" />
  </div>
  <div class="form-group mx-sm-3">
    <label for="end-date">End date:</label>
    <input type="date" name="end_date" id="end-date" class="form-control mx-sm-3"  value="<%= Date.today -%>" />
  </div>

  <input type="submit" value="Import" class="btn btn-primary">
<% end %>

<hr />

<%= form_tag transactions_path, method: :get, class: 'form-inline mt-sm-3' do %>
  <%= label_tag :account_type, 'Account type:' %>
  <%= select_tag :account_type, options_for_select(Account::TYPES, params[:account_type]), include_blank: 'all', class: 'form-control ml-sm-3' %>

  <%= label_tag :allocation, 'Allocation:', class: 'ml-sm-3' %>
  <%= select_tag :allocation, options_for_select(Account::ALLOCATIONS, params[:allocation]), include_blank: 'all', class: 'form-control ml-sm-3' %>

  <input type="submit" value="Search" class="btn btn-secondary ml-sm-3">
<% end %>

<table class="table table-borderless table-striped">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Amount</th>
      <th>Account</th>
      <th>Default allocation</th>
      <th>Year/Month</th>
    </tr>
  </thead>

  <tbody>
    <% @transactions.each do |transaction| %>
      <tr>
        <td class="text-nowrap"><%= transaction.date %></td>
        <td><%= transaction.name %></td>
        <td class="text-right"><%= number_to_currency transaction.amount %></td>
        <td>
          <span class="badge badge-pill badge-secondary">
            <%= transaction.account.name %>
          </span>
        </td>
        <td><%= transaction.account.default_allocation %></td>
        <td><%= transaction.date.slice(0, 7) %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<script type="text/javascript">
(function($) {
  var handler = Plaid.create({
    clientName: 'Plaid Quickstart',
    env: 'development',
    key: '<%= Rails.application.credentials.plaid[:public_key] %>',
    product: ['transactions'],
    onLoad: function() {
      // Optional, called when Link loads
    },
    onSuccess: function(public_token, metadata) {
      // Send the public_token to your app server.
      // The metadata object contains info about the institution the
      // user selected and the account ID or IDs, if the
      // Select Account view is enabled.
      $.post('<%= plaid_items_path %>', {
        public_token: public_token,
      });
    },
    onExit: function(err, metadata) {
      // The user exited the Link flow.
      if (err != null) {
        // The user encountered a Plaid API error prior to exiting.
      }
      // metadata contains information about the institution
      // that the user selected and the most recent API request IDs.
      // Storing this information can be helpful for support.
    },
  });

  $('#link-button').on('click', function(e) {
    handler.open();
  });
})(jQuery);
</script>
